// Nicholas Johnson (www.nicholasjohnson.com)
// Forward Advance Training (www.forwardadvance.com)
// MIT licence

!function(){var e=angular.element(['<div class="widget-placeholder">',"</div>"].join("")),r={size:10,check:function(e){var r,o,n,a;for(o=document.querySelectorAll("[draggable-widget]:not(.dragging)"),r=0;r<o.length;r++){if(n=o[r],a=n.getBoundingClientRect(),width=n.offsetWidth,e.pageY>a.top&&e.pageY<a.bottom&&e.pageX>a.left&&e.pageX<a.right-width/2)return t.insertBefore(n),console.log(r),{group:angular.element(n).scope().dragGroup,index:r};if(e.pageY>a.top&&e.pageY<a.bottom&&e.pageX>a.left+width/2&&e.pageX<a.right)return t.insertAfter(n),console.log(r+1),{group:angular.element(n).scope().dragGroup,index:r+1}}}},t={show:function(r){e[0].hidden=!1,e.css({width:r[0].clientWidth+"px",height:r[0].clientHeight+"px"}),r.after(e)},hide:function(){e[0].hidden=!0},insertBefore:function(r){r.parentElement.insertBefore(e[0],r)},insertAfter:function(r){angular.element(r).after(e)}},o=function(e){var r=e.drag={};r.start=function(e){r.initDrag(e)},r.end=function(e){r.destroyDrag()}};o.$inject=["$scope"],angular.module("ng-draggable-widgets",[]).directive("dragGroup",["$parse",function(e){return{scope:!0,restrict:"A",link:{pre:function(r,t,o){r.dragGroup={},r.dragGroup=e(o.dragGroup)(r)}}}}]).directive("draggableWidget",["$rootScope",function(e){return{scope:!0,restrict:"A",controller:o,link:{pre:function(o,n,a){var i=o.drag,g=function(e){n.css({left:e.pageX-o.drag.offsetX-20+"px",top:e.pageY-o.drag.offsetY-20+"px"})};i.callback=a.draggableWidgetCallback,i.initDrag=function(e){console.log("start drag"),i.offsetX=e.offsetX,i.offsetY=e.offsetY,g(e),n.addClass("dragging"),n.css({position:"absolute","z-index":1e5}),t.show(n),o.drag.source={group:o.dragGroup,index:o.$index},angular.element(window).on("mousemove",function(e){g(e);var t=r.check(e);console.log(t),t&&(o.drag.dest=t)})},o.drag.destroyDrag=function(){var r;console.log("stop drag"),n.removeClass("dragging"),angular.element(window).off("mousemove"),n.css({position:"",left:"",top:"","z-index":""}),t.hide(),o.drag.dest&&(r=o.drag.source.group[o.drag.source.index],o.drag.source.group.splice(o.drag.source.index,1),o.drag.dest.group.splice(o.drag.dest.index,0,r)),i.callback&&o[i.callback](o.drag),e.$apply()}}}}}]).directive("draggableWidgetHandle",function(){return{scope:!0,restrict:"A",link:{pre:function(e,r,t){r.on("mousedown",function(r){e.drag.initDrag(r)}),r.on("mouseup",function(r){e.drag.destroyDrag(r)})}}}})}();