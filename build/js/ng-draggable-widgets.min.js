// Nicholas Johnson (www.nicholasjohnson.com)
// Forward Advance Training (www.forwardadvance.com)
// MIT licence

!function(){var e=angular.element(['<div class="widget-placeholder">',"</div>"].join("")),r={size:10,check:function(e){var r,t,n,a,g;for(t=document.querySelectorAll("[drag-group]"),j=0;j<t.length;j++)for(n=t[j].querySelectorAll("[draggable-widget]:not(.dragging)"),r=0;r<n.length;r++){if(a=n[r],g=a.getBoundingClientRect(),width=a.offsetWidth,e.pageY>g.top&&e.pageY<g.bottom&&e.pageX>g.left&&e.pageX<g.right-width/2)return o.insertBefore(a),console.log(r),{group:angular.element(a).scope().dragGroup,index:r};if(e.pageY>g.top&&e.pageY<g.bottom&&e.pageX>g.left+width/2&&e.pageX<g.right)return o.insertAfter(a),console.log(r+1),{group:angular.element(a).scope().dragGroup,index:r+1}}}},o={show:function(r){e[0].hidden=!1,e.css({width:r[0].clientWidth+"px",height:r[0].clientHeight+"px"}),r.after(e)},hide:function(){e[0].hidden=!0},insertBefore:function(r){r.parentElement.insertBefore(e[0],r)},insertAfter:function(r){angular.element(r).after(e)}},t=function(e){var r=e.drag={};r.start=function(e){r.initDrag(e)},r.end=function(e){r.destroyDrag()}};t.$inject=["$scope"],angular.module("ng-draggable-widgets",[]).directive("dragGroup",["$parse",function(e){return{scope:!0,restrict:"A",link:{pre:function(r,o,t){r.dragGroup={},r.dragGroup=e(t.dragGroup)(r)}}}}]).directive("draggableWidget",["$rootScope",function(e){return{scope:!0,restrict:"A",controller:t,link:{pre:function(t,n,a){var g=t.drag,i=function(e){n.css({left:e.pageX-t.drag.offsetX-20+"px",top:e.pageY-t.drag.offsetY-20+"px"})};g.callback=a.draggableWidgetCallback,g.initDrag=function(e){console.log("start drag"),g.offsetX=e.offsetX,g.offsetY=e.offsetY,i(e),n.addClass("dragging"),n.css({position:"absolute","z-index":1e5}),o.show(n),t.drag.source={group:t.dragGroup,index:t.$index},angular.element(window).on("mousemove",function(e){i(e);var o=r.check(e);console.log(o),o&&(t.drag.dest=o)})},t.drag.destroyDrag=function(){var r;console.log("stop drag"),n.removeClass("dragging"),angular.element(window).off("mousemove"),n.css({position:"",left:"",top:"","z-index":""}),o.hide(),t.drag.dest&&(r=t.drag.source.group[t.drag.source.index],t.drag.source.group.splice(t.drag.source.index,1),t.drag.dest.group.splice(t.drag.dest.index,0,r)),g.callback&&t[g.callback](t.drag),e.$apply()}}}}}]).directive("draggableWidgetHandle",function(){return{scope:!0,restrict:"A",link:{pre:function(e,r,o){r.on("mousedown",function(r){e.drag.initDrag(r)}),r.on("mouseup",function(r){e.drag.destroyDrag(r)})}}}})}();