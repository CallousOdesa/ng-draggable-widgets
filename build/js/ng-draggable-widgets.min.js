// Nicholas Johnson (www.nicholasjohnson.com)
// Forward Advance Training (www.forwardadvance.com)
// MIT licence

!function(){var e={size:10,check:function(e){var t,r,n,i,g;for(r=document.querySelectorAll("[drag-group]"),j=0;j<r.length;j++)for(n=r[j].querySelectorAll("[draggable-widget]:not(.dragging)"),t=0;t<n.length;t++){if(i=n[t],g=i.getBoundingClientRect(),width=i.offsetWidth,e.pageY>g.top&&e.pageY<g.bottom&&e.pageX>g.left&&e.pageX<g.right-width/2)return o.insertBefore(i),console.log(t),{group:angular.element(i).scope().dragGroup,index:t};if(e.pageY>g.top&&e.pageY<g.bottom&&e.pageX>g.left+width/2&&e.pageX<g.right)return o.insertAfter(i),console.log(t+1),{group:angular.element(i).scope().dragGroup,index:t+1}}}},t={initDrag:function(e){e.addClass("dragging"),e.css({position:"absolute","z-index":1e5})},setPosition:function(e,t,o,r,n){e.css({left:t-r-20+"px",top:o-n-20+"px"})},stopDrag:function(e){e.removeClass("dragging"),e.css({position:"",left:"",top:"","z-index":""})},lockSize:function(e){e.css({width:e[0].offsetWidth+"px",height:e[0].offsetHeight+"px"})},unlockSize:function(e){e.css({width:"",height:""})}},o={el:angular.element(['<div class="widget-placeholder">',"</div>"].join("")),show:function(e){o.el[0].hidden=!1,o.el.css({width:e[0].clientWidth+"px",height:e[0].clientHeight+"px"}),e.after(o.el)},hide:function(){o.el[0].hidden=!0},insertBefore:function(e){e.parentElement.insertBefore(o.el[0],e)},insertAfter:function(e){angular.element(e).after(o.el)}},r=function(e){var t=e.drag={};t.start=function(e){t.initDrag(e)},t.end=function(e){t.destroyDrag()}};r.$inject=["$scope"],angular.module("ng-draggable-widgets",[]).directive("dragGroup",["$parse",function(e){return{scope:!0,restrict:"A",link:{pre:function(t,o,r){t.dragGroup={},t.dragGroup=e(r.dragGroup)(t)}}}}]).directive("draggableWidget",["$rootScope",function(n){return{scope:!0,restrict:"A",controller:r,link:{pre:function(r,i,g){var a=r.drag;a.callback=g.draggableWidgetCallback,a.initDrag=function(n){var g;console.log("start drag"),a.offsetX=n.offsetX,a.offsetY=n.offsetY,t.lockSize(i),t.initDrag(i),t.setPosition(i,n.pageX,n.pageY,r.drag.offsetX,r.drag.offsetY),o.show(i),r.drag.source={group:r.dragGroup,index:r.$index},angular.element(window).on("mousemove",function(o){t.setPosition(i,o.pageX,o.pageY,r.drag.offsetX,r.drag.offsetY),g=e.check(o),g&&(r.drag.dest=g,console.log("dest",g))})},r.drag.destroyDrag=function(){var e;console.log("stop drag"),angular.element(window).off("mousemove"),t.stopDrag(i),t.unlockSize(i),o.hide(),r.drag.dest&&(e=r.drag.source.group[r.drag.source.index],r.drag.source.group.splice(r.drag.source.index,1),r.drag.dest.group.splice(r.drag.dest.index,0,e)),a.callback&&r[a.callback](r.drag),n.$apply()}}}}}]).directive("draggableWidgetHandle",function(){return{scope:!0,restrict:"A",link:{pre:function(e,t,o){t.on("mousedown",function(t){e.drag.initDrag(t)}),t.on("mouseup",function(t){e.drag.destroyDrag(t)})}}}})}();